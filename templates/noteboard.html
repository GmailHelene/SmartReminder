{% extends "base.html" %}

{% block title %}{{ board.title }} - Delt tavle - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-chalkboard"></i> {{ board.title }}</h2>
        <p class="text-muted">{{ board.description }}</p>
        <small class="text-muted">Tilgangskode: <strong>{{ board.access_code }}</strong></small>
    </div>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="shareBoardLink('{{ board.access_code }}')">
            <i class="fas fa-share"></i> Del tavle
        </button>
        <a href="{{ url_for('noteboards') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Tilbake
        </a>
    </div>
</div>

<!-- Board Canvas -->
<div class="card mb-4">
    <div class="card-body position-relative" style="min-height: 600px; background: #f8f9fa;">
        <div id="board-canvas" class="position-relative w-100 h-100">
            {% if board.notes %}
                {% for note in board.notes %}
                <div class="sticky-note" id="note-{{ note.id }}" 
                     data-note-id="{{ note.id }}"
                     style="position: absolute; left: {{ note.position.x|default(0) }}px; top: {{ note.position.y|default(0) }}px;">
                    <div class="note-content bg-{{ note.color|default('warning') }} p-3 rounded shadow-sm" 
                         style="width: 200px; min-height: 150px; cursor: move;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ note.author }}</small>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('{{ note.id }}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="note-text">{{ note.content }}</div>
                        <small class="text-muted d-block mt-2">{{ note.created_at | as_datetime | strftime('%d.%m %H:%M') }}</small>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-sticky-note fa-3x mb-3"></i>
                    <h4>Ingen notater ennå</h4>
                    <p>Legg til ditt første notat ved å klikke "Legg til notat" under.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Note Form -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-plus"></i> Legg til nytt notat</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('add_note_to_board', board_id=board.board_id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-floating mb-3">
                        <textarea class="form-control" name="content" placeholder="Skriv ditt notat her..." 
                                  style="height: 100px;" required></textarea>
                        <label>Notat innhold</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-floating mb-3">
                        <select class="form-select" name="color">
                            <option value="warning">Gul</option>
                            <option value="info">Blå</option>
                            <option value="success">Grønn</option>
                            <option value="danger">Rød</option>
                            <option value="light">Hvit</option>
                        </select>
                        <label>Farge</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 h-100">
                        <i class="fas fa-plus"></i><br>Legg til
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Board Members -->
<div class="card mt-4">
    <div class="card-header">
        <h6><i class="fas fa-users"></i> Medlemmer ({{ board.members|length }})</h6>
    </div>
    <div class="card-body">
        <div class="row">
            {% for member in board.members %}
            <div class="col-md-3 mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                    <div>
                        <small class="d-block">{{ member }}</small>
                        {% if member == board.created_by %}
                        <span class="badge bg-primary">Eier</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Make notes draggable
document.addEventListener('DOMContentLoaded', function() {
    const notes = document.querySelectorAll('.sticky-note');
    
    notes.forEach(note => {
        let isDragging = false;
        let startX, startY, noteX, noteY;
        
        const noteContent = note.querySelector('.note-content');
        
        noteContent.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            noteX = note.offsetLeft;
            noteY = note.offsetTop;
            noteContent.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const newX = noteX + (e.clientX - startX);
            const newY = noteY + (e.clientY - startY);
            
            // Keep within bounds
            const canvas = document.getElementById('board-canvas');
            const maxX = canvas.offsetWidth - note.offsetWidth;
            const maxY = canvas.offsetHeight - note.offsetHeight;
            
            const boundedX = Math.max(0, Math.min(newX, maxX));
            const boundedY = Math.max(0, Math.min(newY, maxY));
            
            note.style.left = boundedX + 'px';
            note.style.top = boundedY + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                noteContent.style.cursor = 'move';
                
                // Save position
                const noteId = note.dataset.noteId;
                const x = parseInt(note.style.left);
                const y = parseInt(note.style.top);
                
                updateNotePosition(noteId, x, y);
            }
        });
    });
});

function updateNotePosition(noteId, x, y) {
    fetch(`/api/update-note-position/${noteId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({ x: x, y: y })
    })
    .catch(error => {
        console.error('Error updating note position:', error);
    });
}

function deleteNote(noteId) {
    if (confirm('Er du sikker på at du vil slette dette notatet?')) {
        fetch(`/api/delete-note/${noteId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            }
        })
        .then(response => {
            if (response.ok) {
                document.getElementById(`note-${noteId}`).remove();
            } else {
                alert('Feil ved sletting av notat');
            }
        })
        .catch(error => {
            console.error('Error deleting note:', error);
            alert('Feil ved sletting av notat');
        });
    }
}

function shareBoardLink(accessCode) {
    const link = `${window.location.origin}/join-board?code=${accessCode}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Bli med på delt tavle',
            text: 'Bli med på min delte tavle i Smart Påminner Pro',
            url: link
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(link).then(() => {
            alert('Link kopiert til utklippstavle!');
        }).catch(() => {
            prompt('Kopier denne linken:', link);
        });
    }
}

// Auto-refresh board every 30 seconds to see other users' changes
setInterval(() => {
    if (!document.hidden) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}
