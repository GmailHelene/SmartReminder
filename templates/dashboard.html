{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<!-- Focus Mode Selector -->
<div class="row mb-3">
    <div class="col-md-4">
        <form method="POST" action="{{ url_for('focus_modes') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="input-group">
                <label class="input-group-text" for="focusModeSelect">Fokusmodus</label>
                <select class="form-select" id="focusModeSelect" name="focus_mode">
                    <option value="normal" {% if current_focus_mode == 'normal' %}selected{% endif %}>Normal</option>
                    <option value="focus" {% if current_focus_mode == 'focus' %}selected{% endif %}>Fokus</option>
                    <option value="break" {% if current_focus_mode == 'break' %}selected{% endif %}>Pause</option>
                    <option value="silent" {% if current_focus_mode == 'silent' %}selected{% endif %}>Stillemodus</option>
                    <option value="adhd" {% if current_focus_mode == 'adhd' %}selected{% endif %}>ADHD-modus</option>
                    <option value="driving_school" {% if current_focus_mode == 'driving_school' %}selected{% endif %}>Kj√∏reskolemodus</option>
                    <option value="break" {% if current_focus_mode == 'break' %}selected{% endif %}>Pause</option>
                    <option value="silent" {% if current_focus_mode == 'silent' %}selected{% endif %}>Stillemodus</option>
                    <option value="adhd" {% if current_focus_mode == 'adhd' %}selected{% endif %}>ADHD-modus</option>
                    <option value="driving_school" {% if current_focus_mode == 'driving_school' %}selected{% endif %}>Kj√∏reskolemodus</option>
                </select>
                <button class="btn btn-outline-primary" type="submit">Bytt</button>
            </div>
        </form>
    </div>
</div>
<!-- End Focus Mode Selector -->

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-bell fa-2x mb-2"></i>
                <h3 id="my-count" data-count="my">{{ stats.total }}</h3>
                <small>Mine p√•minnelser</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3 id="completed-count">{{ stats.completed }}</h3>
                <small>Fullf√∏rt</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-share fa-2x mb-2"></i>
                <h3 id="shared-count" data-count="shared">{{ stats.shared_count }}</h3>
                <small>Delt med meg</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-percent fa-2x mb-2"></i>
                <h3>{{ "%.0f"|format(stats.completion_rate) }}%</h3>
                <small>Fullf√∏ringsrate</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <a href="{{ url_for('noteboards') }}" class="text-decoration-none">
            <div class="card bg-primary text-white hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-chalkboard fa-2x mb-2"></i>
                    <h3 id="boards-count">{{ boards_count|default(0) }}</h3>
                    <small>Mine tavler</small>
                </div>
            </div>
        </a>
    </div>
    {% if current_user.email == 'helene721@gmail.com' %}
    <div class="col-md-2 mb-3">
        <a href="{{ url_for('email_settings') }}" class="text-decoration-none">
            <div class="card bg-secondary text-white hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-envelope fa-2x mb-2"></i>
                    <h3><i class="fas fa-cog"></i></h3>
                    <small>E-post innstillinger</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-2 mb-3">
        <a href="{{ url_for('sound_test') }}" class="text-decoration-none">
            <div class="card bg-info text-white hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-volume-up fa-2x mb-2"></i>
                    <h3><i class="fas fa-bell"></i></h3>
                    <small>Test varsellyder</small>
                </div>
            </div>
        </a>
    </div>
    {% endif %}
</div>

<!-- Mine Tavler Section -->
<div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
    <div class="card-header bg-transparent border-0">
        <h5 class="mb-0 text-white">
            <i class="fas fa-chalkboard-teacher"></i> Mine tavler
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <a href="{{ url_for('noteboards') }}" class="text-decoration-none">
                    <div class="card bg-white text-dark hover-shadow h-100" style="transition: all 0.3s ease;">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <i class="fas fa-clipboard-list fa-3x text-primary mb-3"></i>
                            <h6 class="card-title mb-2">Private tavler</h6>
                            <p class="card-text text-muted small mb-0">
                                <span class="badge bg-primary">{{ boards_count|default(0) }}</span> tavler tilgjengelig
                            </p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-6 mb-3">
                <a href="{{ url_for('noteboards') }}" class="text-decoration-none">
                    <div class="card bg-white text-dark hover-shadow h-100" style="transition: all 0.3s ease;">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <i class="fas fa-users fa-3x text-success mb-3"></i>
                            <h6 class="card-title mb-2">Delte tavler</h6>
                            <p class="card-text text-muted small mb-0">
                                <span class="badge bg-success">{{ shared_boards_count|default(0) }}</span> delte tavler
                            </p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <a href="{{ url_for('noteboards') }}" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-plus"></i> Opprett ny tavle
                </a>
                <button class="btn btn-outline-light btn-sm me-2" onclick="showJoinBoardModal()">
                    <i class="fas fa-sign-in-alt"></i> Bli med p√• tavle
                </button>
                <button id="enablePushBtn" class="btn btn-outline-light btn-sm me-2" onclick="requestPushPermission()" style="display: none;">
                    <i class="fas fa-bell"></i> Aktiver varsler
                </button>
                <button id="installBtn" class="btn btn-outline-light btn-sm" onclick="installApp()" style="display: none;">
                    <i class="fas fa-download"></i> Installer app
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Board Join Modal -->
<div class="modal fade" id="quickJoinBoardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sign-in-alt"></i> Bli med p√• tavle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('join_board') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-floating mb-3">
                        <input type="text" name="access_code" class="form-control" 
                               placeholder="TAVLE123" required style="text-transform: uppercase;">
                        <label>Tilgangskode</label>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Skriv inn tilgangskoden du mottok for √• bli med p√• en delt tavle.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Bli med
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Reminder Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-plus"></i> Ny p√•minnelse</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('add_reminder') }}" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <div class="form-floating mb-3">
                        {{ form.title(class="form-control", placeholder="Tittel", required=true) }}
                        {{ form.title.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-6 col-md-12">
                    <div class="form-floating mb-3">
                        {{ form.category(class="form-select") }}
                        {{ form.category.label(class="form-label") }}
                    </div>
                </div>
            </div>

            <div class="form-floating mb-3">
                {{ form.description(class="form-control", placeholder="Beskrivelse", rows="3") }}
                {{ form.description.label(class="form-label") }}
            </div>

            <div class="row">
                <div class="col-lg-4 col-md-6 col-sm-12">
                    <div class="form-floating mb-3">
                        {{ form.date(class="form-control", required=true) }}
                        {{ form.date.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-12">
                    <div class="form-floating mb-3">
                        {{ form.time(class="form-control", required=true) }}
                        {{ form.time.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 col-sm-12">
                    <div class="form-floating mb-3">
                        {{ form.priority(class="form-select") }}
                        {{ form.priority.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 col-sm-12">
                    <div class="form-floating mb-3">
                        <select class="form-select" name="sound" id="soundSelect" onchange="previewSound(this.value)">
                            <option value="pristine.mp3">Standard</option>
                            <option value="ding.mp3">Ding</option>
                            <option value="chime.mp3">Chime</option>
                            <option value="alert.mp3">Alert</option>
                        </select>
                        <label for="soundSelect">Varsellyd</label>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="previewSound(document.getElementById('soundSelect').value)">
                            <i class="fas fa-volume-up"></i> Test lyd
                        </button>
                    </div>
                </div>
            </div>

            {% if available_users %}
            <div class="mb-3">
                <label class="form-label">Del med:</label>
                <div class="row">
                    {% for user in available_users %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="share_with" value="{{ user }}" id="user_{{ loop.index }}">
                            <label class="form-check-label" for="user_{{ loop.index }}">
                                {{ user }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="d-grid">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>

<!-- My Reminders -->
<div class="row">
    <div class="col-lg-6 col-md-12 dashboard-col">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Mine p√•minnelser</h5>
                <span class="badge bg-primary">{{ my_reminders|length }}</span>
            </div>
            <div class="card-body">
                {% if my_reminders %}
                    {% for reminder in my_reminders %}
                    <div class="reminder-item card mb-3 priority-{{ reminder.priority.lower() }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">{{ reminder.title }}</h6>
                                    {% if reminder.description %}
                                    <p class="card-text text-muted small">{{ reminder.description }}</p>
                                    {% endif %}
                                    <div class="d-flex gap-2 flex-wrap">
                                        <span class="badge bg-primary">{{ reminder.datetime | format_datetime }}</span>
                                        <span class="badge category-badge bg-secondary">{{ reminder.category }}</span>
                                        <span class="badge bg-{{ 'danger' if reminder.priority == 'H√∏y' else 'warning' if reminder.priority == 'Medium' else 'success' }}">
                                            {{ reminder.priority }}
                                        </span>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('complete_reminder', reminder_id=reminder.id) }}">
                                            <i class="fas fa-check text-success"></i> Fullf√∏r
                                        </a></li>
                                        <li><button class="dropdown-item" onclick="shareReminder('{{ reminder.id }}', '{{ reminder.title }}')">
                                            <i class="fas fa-share text-info"></i> Del via e-post
                                        </button></li>
                                        <li><a class="dropdown-item" href="{{ url_for('delete_reminder', reminder_id=reminder.id) }}" 
                                               onclick="return confirm('Er du sikker p√• at du vil slette denne p√•minnelsen?')">
                                            <i class="fas fa-trash text-danger"></i> Slett
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bell-slash fa-3x mb-3"></i>
                        <p>Ingen p√•minnelser enn√•</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Shared Reminders -->
    <div class="col-lg-6 col-md-12 dashboard-col">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-share"></i> Delt med meg</h5>
                <span class="badge bg-info">{{ shared_reminders|length }}</span>
            </div>
            <div class="card-body">
                {% if shared_reminders %}
                    {% for reminder in shared_reminders %}
                    <div class="reminder-item card mb-3 priority-{{ reminder.priority.lower() }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        {{ reminder.title }}
                                        <small class="text-muted">av {{ reminder.shared_by }}</small>
                                    </h6>
                                    {% if reminder.description %}
                                    <p class="card-text text-muted small">{{ reminder.description }}</p>
                                    {% endif %}
                                    <div class="d-flex gap-2 flex-wrap">
                                        <span class="badge bg-primary">{{ reminder.datetime | format_datetime }}</span>
                                        <span class="badge category-badge bg-secondary">{{ reminder.category }}</span>
                                        <span class="badge bg-{{ 'danger' if reminder.priority == 'H√∏y' else 'warning' if reminder.priority == 'Medium' else 'success' }}">
                                            {{ reminder.priority }}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <a href="{{ url_for('complete_reminder', reminder_id=reminder.id) }}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-check"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-share-alt fa-3x mb-3"></i>
                        <p>Ingen delte p√•minnelser</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Kalendervisning</h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="calendarView" id="monthView" autocomplete="off" checked>
                    <label class="btn btn-outline-primary btn-sm" for="monthView">M√•ned</label>
                    
                    <input type="radio" class="btn-check" name="calendarView" id="weekView" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="weekView">Uke</label>
                    
                    <input type="radio" class="btn-check" name="calendarView" id="dayView" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="dayView">Dag</label>
                </div>
            </div>
            <div class="card-body p-1 p-md-3">
                <!-- Removed loading indicator per user request -->
                
                <!-- Mobile calendar fallback -->
                <div id="calendar-fallback" class="text-center p-4" style="display: none; min-height: 400px; background: white; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                    <div class="mt-5">
                        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Kalender utilgjengelig</h5>
                        <p class="text-muted small">Kalenderen kunne ikke lastes. Pr√∏v √• oppdatere siden.</p>
                        <button onclick="location.reload()" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-refresh"></i> Oppdater side
                        </button>
                    </div>
                </div>
                
                <div id="calendar" style="min-height: 400px; background: white;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Share Reminder Modal -->
<div class="modal fade" id="shareReminderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-share"></i> Del p√•minnelse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('share_reminder') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="reminder_id" id="shareReminderIdInput">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">P√•minnelse:</label>
                        <p class="text-muted" id="shareReminderTitle"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailAddresses" class="form-label fw-bold">E-post adresser:</label>
                        <textarea class="form-control" name="email_addresses" id="emailAddresses" 
                                  rows="3" placeholder="Skriv inn e-post adresser separert med komma eller mellomrom"
                                  required></textarea>
                        <div class="form-text">Eksempel: person1@example.com, person2@example.com</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="personalMessage" class="form-label">Personlig melding (valgfritt):</label>
                        <textarea class="form-control" name="personal_message" id="personalMessage" 
                                  rows="3" placeholder="Legg til en personlig melding..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send p√•minnelse
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Reminder Modal -->
<div class="modal fade" id="quickReminderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö° Hurtig p√•minnelse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickReminderForm" action="/add_reminder" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="quickDate" name="date">
                    <input type="hidden" id="quickTime" name="time">
                    
                    <div class="mb-3">
                        <label for="quickTitle" class="form-label">Tittel</label>
                        <input type="text" class="form-control" id="quickTitle" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickDescription" class="form-label">Beskrivelse (valgfritt)</label>
                        <textarea class="form-control" id="quickDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="quickCategory" class="form-label">Kategori</label>
                            <select class="form-select" id="quickCategory" name="category">
                                <option value="Helse">‚öïÔ∏è Helse</option>
                                <option value="Familie">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie</option>
                                <option value="√òkonomi">üí∞ √òkonomi</option>
                                <option value="Utdanning">üìö Utdanning</option>
                                <option value="Annet" selected>üìé Annet</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quickPriority" class="form-label">Prioritet</label>
                            <select class="form-select" id="quickPriority" name="priority">
                                <option value="Lav">üü¢ Lav</option>
                                <option value="Medium" selected>üü° Medium</option>
                                <option value="H√∏y">üî¥ H√∏y</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            üìÖ <span id="selectedDateDisplay"></span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Opprett p√•minnelse
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsTitle">üìã P√•minnelse detaljer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetailsBody">
                <!-- Event details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
                <button type="button" class="btn btn-primary" id="shareEventBtn">
                    <i class="fas fa-share"></i> Del via e-post
                </button>
                <button type="button" class="btn btn-success" id="completeEventBtn">
                    <i class="fas fa-check"></i> Fullf√∏r
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="eventContextMenu" class="dropdown-menu" style="display: none; position: absolute; z-index: 1055;">
    <a class="dropdown-item" href="#" id="shareEventContext">
        <i class="fas fa-share"></i> Del via e-post
    </a>
    <a class="dropdown-item" href="#" id="editEventContext">
        <i class="fas fa-edit"></i> Rediger
    </a>
    <a class="dropdown-item" href="#" id="completeEventContext">
        <i class="fas fa-check"></i> Fullf√∏r
    </a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item text-danger" href="#" id="deleteEventContext">
        <i class="fas fa-trash"></i> Slett
    </a>
</div>

{% if current_focus_mode == 'driving_school' %}
<!-- KJ√òRESKOLEMODUS WIDGETS -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <i class="fas fa-car"></i> Kj√∏reskole: Instrukt√∏rstatus
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('set_instructor_status') }}" class="row g-2 align-items-center">
      <div class="col-auto">
        <label for="statusSelect" class="form-label mb-0">Status:</label>
      </div>
      <div class="col-auto">
        <select class="form-select" id="statusSelect" name="status">
          <option value="ledig">Ledig</option>
          <option value="opptatt">Opptatt</option>
          <option value="p√•_vei">P√• vei</option>
          <option value="pause">Pause</option>
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-success" type="submit">Oppdater</button>
      </div>
    </form>
    <div class="mt-3">
      <strong>Alle instrukt√∏rer:</strong>
      <ul class="list-unstyled mb-0">
        {% for instr in instructors %}
        <li>{{ instr.name }}: <span class="badge bg-info">{{ instr.status }}</span></li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-bolt"></i> Hurtigbeskjed
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('send_quick_message') }}" class="row g-2 align-items-center">
      <div class="col-auto">
        <select class="form-select" name="template">
          <option value="Husk √• fylle drivstoff">Husk √• fylle drivstoff</option>
          <option value="Ta med l√¶rebok">Ta med l√¶rebok</option>
          <option value="Ring kontoret etter timen">Ring kontoret etter timen</option>
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-primary" type="submit">Send</button>
      </div>
    </form>
    <div class="mt-2">
      <strong>Raske svar:</strong>
      <button class="btn btn-sm btn-outline-secondary me-1" onclick="sendQuickReply('OK')">OK</button>
      <button class="btn btn-sm btn-outline-secondary me-1" onclick="sendQuickReply('P√• vei')">P√• vei</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="sendQuickReply('Trenger mer tid')">Trenger mer tid</button>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-warning text-dark">
    <i class="fas fa-clock"></i> Blir forsinket
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('notify_delay') }}" class="row g-2 align-items-center">
      <div class="col-auto">
        <label for="delayMinutes" class="form-label mb-0">Antall minutter:</label>
      </div>
      <div class="col-auto">
        <input type="number" min="1" max="60" class="form-control" id="delayMinutes" name="minutes" value="5">
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-warning" type="submit">Send forsinkelse</button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <i class="fas fa-book"></i> Kj√∏retime-logg
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('log_lesson') }}" class="row g-2 align-items-center">
      <div class="col-auto">
        <label for="lessonNote" class="form-label mb-0">Notat:</label>
      </div>
      <div class="col-auto">
        <input type="text" class="form-control" id="lessonNote" name="note" placeholder="Startet time, Avsluttet, Avvik...">
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-info" type="submit">Logg</button>
      </div>
    </form>
    <div class="mt-2">
      <strong>Siste logg:</strong>
      <ul class="list-unstyled mb-0">
        {% for entry in lesson_log %}
        <li>{{ entry.timestamp }}: {{ entry.note }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
<!-- SLUTT KJ√òRESKOLEMODUS WIDGETS -->
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
// CSRF Token refresh - fix for token expiration issues
document.addEventListener('DOMContentLoaded', function() {
    // Make sure all forms have a valid CSRF token
    const refreshCSRFTokens = function() {
        // Fetch a new CSRF token via a small hidden iframe
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = '/dashboard';
        iframe.onload = function() {
            try {
                const csrfToken = iframe.contentDocument.querySelector('input[name="csrf_token"]').value;
                if (csrfToken) {
                    // Update all CSRF tokens on the page
                    document.querySelectorAll('input[name="csrf_token"]').forEach(input => {
                        input.value = csrfToken;
                    });
                    console.log('CSRF tokens refreshed');
                }
                // Remove iframe after use
                document.body.removeChild(iframe);
            } catch (e) {
                console.error('Failed to refresh CSRF token:', e);
            }
        };
        document.body.appendChild(iframe);
    };
    
    // Refresh tokens immediately on page load
    refreshCSRFTokens();
    
    // Refresh tokens every 5 minutes to avoid expiration
    setInterval(refreshCSRFTokens, 5 * 60 * 1000);
    
    // Also refresh if the user becomes active after inactivity
    let inactiveTime = 0;
    const checkActivity = setInterval(function() {
        inactiveTime += 1;
        if (inactiveTime > 30) { // 30 minutes of inactivity
            refreshCSRFTokens();
            inactiveTime = 0;
        }
    }, 60 * 1000); // Check every minute
    
    // Reset inactive timer on user activity
    const resetInactiveTimer = function() {
        inactiveTime = 0;
    };
    
    // Listen for user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, resetInactiveTimer, true);
    });
});
</script>

<!-- FullCalendar CSS & JS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<script>
// Simplified calendar initialization - no complex auth checking
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Starting simplified calendar initialization...');
    
    const calendarEl = document.getElementById('calendar');
    const loadingEl = document.getElementById('calendar-loading');
    const fallbackEl = document.getElementById('calendar-fallback');
    
    if (!calendarEl) {
        console.error('‚ùå Calendar element not found');
        return;
    }
    
    
    // Show loading briefly then hide it automatically
    if (loadingEl) {
        loadingEl.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Laster kalender...</p></div>';
        loadingEl.style.display = 'block';
        // Will be hidden automatically after 500ms by the timeout at the end of the script
    }
    
    // Hide fallback initially  
    if (fallbackEl) {
        fallbackEl.style.display = 'none';
    }
    
    // Initialize calendar with direct URL
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: window.innerWidth < 768 ? 400 : 600,
        
        // Simple events loading
        events: '/api/calendar-events',
        
        // Loading callback - DISABLED per user request
        // loading: function(isLoading) {
        //     console.log('üìÖ Calendar loading state:', isLoading);
        //     if (loadingEl) {
        //         loadingEl.style.display = isLoading ? 'block' : 'none';
        //     }
        // },
        
        // Event source error callback
        eventSourceFailure: function(error) {
            console.error('‚ùå Calendar event loading failed:', error);
            if (fallbackEl) {
                fallbackEl.innerHTML = `
                    <div class="text-center p-4 mt-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-muted">Kunne ikke laste kalenderdata</h5>
                        <p class="text-muted small">Sjekk at du er logget inn og pr√∏v igjen.</p>
                        <button onclick="location.reload()" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-refresh"></i> Last p√• nytt
                        </button>
                    </div>
                `;
                fallbackEl.style.display = 'block';
            }
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        },
        
        // Basic responsive header
        headerToolbar: {
            left: window.innerWidth < 768 ? 'prev,next' : 'prev,next today',
            center: 'title',
            right: window.innerWidth < 768 ? 'dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        
        // Enable interactions
        selectable: true,
        editable: true,
        
        // Event handlers
        dateClick: function(info) {
            console.log('üìÖ Date clicked:', info.dateStr);
            showQuickReminderModal(info.date, null, true);
        },
        
        eventClick: function(info) {
            console.log('üìã Event clicked:', info.event.title);
            showEventDetailsModal(info.event);
        }
    });
    
    // Render calendar
    console.log('üé® Rendering calendar...');
    calendar.render();
    
    // Store globally for other functions
    window.calendar = calendar;
    
    // Force visibility for mobile
    if (window.innerWidth < 768) {
        setTimeout(() => {
            console.log('üì± Applying mobile calendar fixes...');
            calendarEl.style.minHeight = '400px';
            calendarEl.style.background = 'white';
            calendarEl.style.display = 'block';
            calendarEl.style.visibility = 'visible';
            calendar.updateSize();
        }, 500);
    }
    
    // Timeout fallback - DISABLED per user request
    setTimeout(() => {
        // Calendar loading timeout disabled
    }, 10000);
    
    console.log('‚úÖ Calendar initialization completed');
});

// Calendar initialization
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    if (!calendarEl) {
        console.error('Calendar element not found');
        return;
    }
    
    // Show loading indicator
    const loadingEl = document.getElementById('calendar-loading');
    if (loadingEl) {
        loadingEl.style.display = 'block';
    }
    
    // Check authentication before initializing calendar
    checkUserAuthentication().then(isAuthenticated => {
        if (!isAuthenticated) {
            console.warn('User not authenticated, showing login message');
            const fallbackEl = document.getElementById('calendar-fallback');
            if (fallbackEl) {
                fallbackEl.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-lock fa-3x text-danger mb-3"></i>
                        <h5>Du m√• logge inn</h5>
                        <p class="text-muted">Kalenderen krever innlogging for √• laste data.</p>
                        <a href="/login" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Logg inn
                        </a>
                    </div>
                `;
                fallbackEl.style.display = 'block';
            }
            if (loadingEl) loadingEl.style.display = 'none';
            return;
        }
        
        // User is authenticated, proceed with calendar initialization
        initializeCalendar();
    }).catch(error => {
        console.error('Authentication check failed:', error);
        // Proceed with calendar initialization anyway
        initializeCalendar();
    });
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    const loadingEl = document.getElementById('calendar-loading');
    
    // Prevent multiple calendar initialization
    if (window.calendar) {
        window.calendar.destroy();
    }
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: window.innerWidth < 768 ? 400 : 600,
        contentHeight: window.innerWidth < 768 ? 400 : 600,
        aspectRatio: window.innerWidth < 768 ? 1.2 : 1.35,
        events: function(info, successCallback, failureCallback) {
            // Custom event loading with better error handling
            loadCalendarEvents()
                .then(events => {
                    console.log('Events loaded successfully:', events.length);
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Event loading failed:', error);
                    failureCallback(error);
                });
        },
        loading: function(isLoading) {
            const loadingEl = document.getElementById('calendar-loading');
            const fallbackEl = document.getElementById('calendar-fallback');
            
            if (loadingEl) {
                loadingEl.style.display = isLoading ? 'block' : 'none';
            }
            
            console.log('Calendar loading:', isLoading);
            
            // Mobile-specific loading timeout check
            if (isLoading && window.innerWidth < 768) {
                setTimeout(() => {
                    if (loadingEl && loadingEl.style.display !== 'none') {
                        console.warn('Calendar taking too long to load on mobile, showing fallback');
                        loadingEl.style.display = 'none';
                        if (fallbackEl) fallbackEl.style.display = 'block';
                    }
                }, 10000); // 10 second timeout
            }
        },
        headerToolbar: {
            left: window.innerWidth < 768 ? 'prev,next' : 'prev,next today',
            center: 'title',
            right: window.innerWidth < 768 ? 'dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        selectable: true,
        editable: true,
        droppable: true,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        select: function(arg) {
            // Opprett ny p√•minnelse ved √• dra over flere dager/tid
            showQuickReminderModal(arg.start, arg.end, arg.allDay);
        },
        dateClick: function(info) {
            // Opprett ny p√•minnelse ved √• klikke p√• en dag
            showQuickReminderModal(info.date, null, info.allDay);
        },
        eventClick: function(info) {
            // Vis event detaljer med deling-mulighet
            showEventDetailsModal(info.event);
        },
        eventDrop: function(info) {
            // Oppdater p√•minnelse n√•r den flyttes
            updateReminderDateTime(info.event.id, info.event.start);
        },
        eventResize: function(info) {
            // Oppdater p√•minnelse n√•r varigheten endres
            updateReminderDateTime(info.event.id, info.event.start, info.event.end);
        },
        eventDidMount: function(info) {
            // Add tooltip and context menu
            info.el.setAttribute('title', info.event.extendedProps.description || '');
             
            // Legg til h√∏yreklikk for deling
            info.el.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showEventContextMenu(e, info.event);
            });
        }
    });
    
    calendar.render();
    window.calendar = calendar;
    
    // Enhanced mobile calendar debugging and fixes
    const isMobile = window.innerWidth < 768;
    console.log('Calendar initialized:', {
        width: window.innerWidth,
        height: window.innerHeight,
        isMobile: isMobile,
        calendarElement: calendarEl,
        calendarHeight: calendar.getOption('height'),
        calendarView: calendar.view.type
    });
    
    // Force calendar to be visible on mobile with multiple render attempts
    if (isMobile) {
        console.log('Applying mobile calendar fixes...');
        
        // Immediate fixes
        calendarEl.style.minHeight = '400px';
        calendarEl.style.background = 'white';
        calendarEl.style.display = 'block';
        calendarEl.style.visibility = 'visible';
        
        // Multiple render attempts for mobile
        setTimeout(() => {
            console.log('Mobile calendar render attempt 1');
            calendar.updateSize();
            calendar.render();
        }, 100);
        
        setTimeout(() => {
            console.log('Mobile calendar render attempt 2');
            calendar.updateSize();
            
            // Force show calendar if still not visible
            const fcView = calendarEl.querySelector('.fc-view-harness');
            if (fcView) {
                fcView.style.background = 'white';
                fcView.style.minHeight = '400px';
                fcView.style.display = 'block';
            }
        }, 500);
        
        setTimeout(() => {
            console.log('Mobile calendar render attempt 3');
            
            // Final check and force visibility
            const fcElements = calendarEl.querySelectorAll('.fc, .fc-view-harness, .fc-scrollgrid');
            fcElements.forEach(el => {
                el.style.background = 'white';
                el.style.display = 'block';
                el.style.visibility = 'visible';
            });
            
            calendar.updateSize();
            
            // Final visibility check - if calendar is still not properly visible, show fallback
            setTimeout(() => {
                const fcView = calendarEl.querySelector('.fc-view-harness');
                const fcScrollGrid = calendarEl.querySelector('.fc-scrollgrid');
                
                if (!fcView || !fcScrollGrid || fcView.offsetHeight < 50) {
                    console.warn('Calendar still not visible after all attempts, showing fallback');
                    const fallbackEl = document.getElementById('calendar-fallback');
                    if (fallbackEl) {
                        calendarEl.style.display = 'none';
                        fallbackEl.style.display = 'block';
                    }
                }
            }, 500);
        }, 1000);
    }
    
    // Handle window resize for mobile responsiveness
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (calendar) {
                // Update calendar options based on screen size
                const isMobile = window.innerWidth < 768;
                calendar.setOption('height', isMobile ? 400 : 600);
                calendar.setOption('contentHeight', isMobile ? 400 : 600);
                calendar.setOption('aspectRatio', isMobile ? 1.2 : 1.35);
                calendar.setOption('headerToolbar', {
                    left: isMobile ? 'prev,next' : 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
                });
                calendar.updateSize();
            }
        }, 250);
    });
    
    // Force calendar to render properly on mobile
    setTimeout(() => {
        if (calendar && window.innerWidth < 768) {
            calendar.updateSize();
        }
    }, 500);
    
    // Calendar view switcher
    document.querySelectorAll('input[name="calendarView"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.id === 'monthView') {
                calendar.changeView('dayGridMonth');
            } else if (this.id === 'weekView') {
                calendar.changeView('timeGridWeek');
            } else if (this.id === 'dayView') {
                calendar.changeView('timeGridDay');
            }
        });
    });
    
    // Quick reminder form event listener (only add once)
    const quickForm = document.getElementById('quickReminderForm');
    if (quickForm && !quickForm.hasAttribute('data-listener-added')) {
        quickForm.setAttribute('data-listener-added', 'true');
        quickForm.addEventListener('submit', handleQuickReminderSubmit);
    }
}
    
// Show join board modal
function showJoinBoardModal() {
    const modal = new bootstrap.Modal(document.getElementById('quickJoinBoardModal'));
    modal.show();
    
    // Focus on access code input
    setTimeout(() => {
        document.querySelector('#quickJoinBoardModal input[name="access_code"]').focus();
    }, 500);
}

// Auto-uppercase access code input
document.addEventListener('DOMContentLoaded', function() {
    const accessCodeInput = document.querySelector('#quickJoinBoardModal input[name="access_code"]');
    if (accessCodeInput) {
        accessCodeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
});

// Share reminder function
function shareReminder(reminderId, reminderTitle) {
    document.getElementById('shareReminderIdInput').value = reminderId;
    document.getElementById('shareReminderTitle').textContent = reminderTitle;
    
    var modal = new bootstrap.Modal(document.getElementById('shareReminderModal'));
    modal.show();
}

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Update reminder count
function updateReminderCount() {
    fetch('/api/reminder-count')
        .then(response => response.json())
        .then(data => {
            if (data.my_count !== undefined) {
                const myCountEl = document.querySelector('[data-count="my"]');
                if (myCountEl) myCountEl.textContent = data.my_count;
            }
            if (data.shared_count !== undefined) {
                const sharedCountEl = document.querySelector('[data-count="shared"]');
                if (sharedCountEl) sharedCountEl.textContent = data.shared_count;
            }
            if (data.total_count !== undefined) {
                const totalCountEl = document.querySelector('[data-count="total"]');
                if (totalCountEl) totalCountEl.textContent = data.total_count;
            }
        })
        .catch(error => console.log('Error updating reminder count:', error));
}

// Auto-refresh reminder count every 5 minutes
setInterval(updateReminderCount, 300000);

// Quick reminder modal functions
function showQuickReminderModal(startDate, endDate, allDay) {
    const modal = new bootstrap.Modal(document.getElementById('quickReminderModal'));
    
    // Ensure we have valid dates
    if (!startDate) {
        console.error('showQuickReminderModal called without startDate');
        return;
    }
    
    // Set date and time values
    const date = new Date(startDate);
    if (isNaN(date.getTime())) {
        console.error('Invalid date provided to showQuickReminderModal:', startDate);
        return;
    }
    
    const dateStr = date.toISOString().split('T')[0];
    const timeStr = allDay ? '09:00' : date.toTimeString().slice(0, 5);
    
    document.getElementById('quickDate').value = dateStr;
    document.getElementById('quickTime').value = timeStr;
    
    // Safe date formatting
    try {
        document.getElementById('selectedDateDisplay').textContent = 
            date.toLocaleDateString('nb-NO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) + (allDay ? '' : ` kl. ${timeStr}`);
    } catch (e) {
        console.error('Error formatting date:', e);
        document.getElementById('selectedDateDisplay').textContent = `${dateStr} ${timeStr}`;
    }
    
    // Clear form
    document.getElementById('quickTitle').value = '';
    document.getElementById('quickDescription').value = '';
    document.getElementById('quickCategory').value = 'Annet';
    document.getElementById('quickPriority').value = 'Medium';
    
    modal.show();
    
    // Focus on title field
    setTimeout(() => {
        document.getElementById('quickTitle').focus();
    }, 500);
}

// Event details modal
function showEventDetailsModal(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    const props = event.extendedProps;
    
    document.getElementById('eventDetailsTitle').textContent = event.title;
    
    let detailsHtml = `
        <div class="row">
            <div class="col-12 mb-3">
                <h6>${event.title}</h6>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>üìÖ Dato og tid:</strong><br>
                <span class="text-muted">${event.start.toLocaleString('nb-NO')}</span>
            </div>
            <div class="col-md-6">
                <strong>üè∑Ô∏è Kategori:</strong><br>
                <span class="badge bg-secondary">${props.category}</span>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>‚ö° Prioritet:</strong><br>
                <span class="badge bg-${props.priority === 'H√∏y' ? 'danger' : props.priority === 'Medium' ? 'warning' : 'success'}">${props.priority}</span>
            </div>
            ${props.sharedBy ? `<div class="col-md-6"><strong>üë§ Delt av:</strong><br><span class="text-muted">${props.sharedBy}</span></div>` : ''}
        </div>
    `;
    
    if (props.description) {
        detailsHtml += `
            <div class="mb-3">
                <strong>üìù Beskrivelse:</strong><br>
                <div class="text-muted">${props.description}</div>
            </div>
        `;
    }
    
    document.getElementById('eventDetailsBody').innerHTML = detailsHtml;
    
    // Set up action buttons
    const shareBtn = document.getElementById('shareEventBtn');
    const completeBtn = document.getElementById('completeEventBtn');
    
    shareBtn.onclick = () => {
        modal.hide();
        shareEventViaEmail(event);
    };
    
    if (props.type === 'my') {
        completeBtn.style.display = 'block';
        completeBtn.onclick = () => {
            completeReminder(event.id);
            modal.hide();
        };
    } else {
        completeBtn.style.display = 'none';
    }
    
    modal.show();
}

// Context menu
let currentContextEvent = null;

function showEventContextMenu(e, event) {
    const menu = document.getElementById('eventContextMenu');
    currentContextEvent = event;
    
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.style.display = 'block';
    
    // Hide on click outside
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu, { once: true });
    }, 100);
}

function hideContextMenu() {
    document.getElementById('eventContextMenu').style.display = 'none';
    currentContextEvent = null;
}

// Context menu actions
document.getElementById('shareEventContext').addEventListener('click', function(e) {
    e.preventDefault();
    if (currentContextEvent) {
        shareEventViaEmail(currentContextEvent);
        hideContextMenu();
    }
});

document.getElementById('completeEventContext').addEventListener('click', function(e) {
    e.preventDefault();
    if (currentContextEvent && currentContextEvent.extendedProps.type === 'my') {
        completeReminder(currentContextEvent.id);
        hideContextMenu();
    }
});

// Share event via email
function shareEventViaEmail(event) {
    document.getElementById('shareReminderIdInput').value = event.id.replace('shared_', '');
    document.getElementById('shareReminderTitle').textContent = event.title;
    document.getElementById('emailAddresses').value = '';
    document.getElementById('personalMessage').value = '';
    
    const shareModal = new bootstrap.Modal(document.getElementById('shareReminderModal'));
    shareModal.show();
}

// Override the share form submission to use calendar API
document.getElementById('shareReminderModal').querySelector('form').addEventListener('submit', function(e) {
    if (currentContextEvent) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            reminder_id: formData.get('reminder_id'),
            email_addresses: formData.get('email_addresses'),
            personal_message: formData.get('personal_message')
        };
        
        fetch('/api/share-calendar-event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrf_token')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToastNotification('üìß ' + (data.message || 'Kalenderinvitasjon sendt!'), 'success');
                bootstrap.Modal.getInstance(document.getElementById('shareReminderModal')).hide();
            } else {
                showToastNotification('‚ùå ' + (data.error || 'Kunne ikke sende invitasjon'), 'error');
            }
        })
        .catch(error => {
            console.error('Error sharing calendar event:', error);
            showToastNotification('‚ùå Feil ved sending av invitasjon', 'error');
        });
    }
});

// Update reminder date/time via drag & drop
function updateReminderDateTime(eventId, newStart, newEnd) {
    const cleanId = eventId.replace('shared_', '');
    const newDate = newStart.toISOString().split('T')[0];
    const newTime = newStart.toTimeString().slice(0, 5);
    
    // Get CSRF token from any form on the page
    const csrfToken = document.querySelector('input[name=csrf_token]').value;
    
    fetch('/api/update-reminder-datetime', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            reminder_id: cleanId,
            date: newDate,
            time: newTime
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToastNotification('üìÖ P√•minnelse oppdatert!', 'success');
        } else {
            showToastNotification('‚ùå Kunne ikke oppdatere p√•minnelse: ' + (data.error || 'Ukjent feil'), 'error');
            // Revert calendar if needed
            if (window.calendar) {
                window.calendar.refetchEvents();
            }
        }
    })
    .catch(error => {
        console.error('Error updating reminder:', error);
        showToastNotification('‚ùå Feil ved oppdatering: ' + error.message, 'error');
        if (window.calendar) {
            window.calendar.refetchEvents();
        }
    });
}

// Complete reminder function
function completeReminder(reminderId) {
    const cleanId = reminderId.replace('shared_', '');
    
    fetch(`/complete_reminder/${cleanId}`, {
        method: 'GET'
    })
    .then(response => {
        if (response.ok) {
            showToastNotification('‚úÖ P√•minnelse fullf√∏rt!', 'success');
            if (window.calendar) {
                window.calendar.refetchEvents();
            }
            // Update reminder count instead of reloading
            updateReminderCount();
        } else {
            showToastNotification('‚ùå Kunne ikke fullf√∏re p√•minnelse', 'error');
        }
    })
    .catch(error => {
        console.error('Error completing reminder:', error);
        showToastNotification('‚ùå Feil ved fullf√∏ring', 'error');
    });
}

// Quick reminder form submission handler
function handleQuickReminderSubmit(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Validate required fields
    if (!data.title || !data.date || !data.time) {
        showToastNotification('‚ùå Tittel, dato og tid er p√•krevd', 'error');
        return false;
    }
    
    // Extra validation for data integrity
    if (data.title.length > 200) {
        showToastNotification('‚ùå Tittel er for lang (maks 200 tegn)', 'error');
        return false;
    }
    
    // Get CSRF token specifically from this form
    const csrfToken = form.querySelector('[name=csrf_token]').value;
    if (!csrfToken) {
        showToastNotification('‚ùå Sikkerhetsfeil - pr√∏v √• last siden p√• nytt', 'error');
        return false;
    }
    
    // Disable submit button to prevent double submission
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Oppretter...';
    }
    
    fetch('/add_reminder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToastNotification('‚úÖ P√•minnelse opprettet!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('quickReminderModal')).hide();
            
            // Properly refresh calendar events
            if (window.calendar) {
                window.calendar.refetchEvents();
            }
            // Update reminder count
            updateReminderCount();
        } else {
            showToastNotification('‚ùå Kunne ikke opprette p√•minnelse: ' + (data.error || 'Ukjent feil'), 'error');
        }
    })
    .catch(error => {
        console.error('Error creating reminder:', error);
        showToastNotification('‚ùå Feil ved opprettelse: ' + error.message, 'error');
    })
    .finally(() => {
        // Re-enable submit button
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Opprett p√•minnelse';
        }
    });
    
    return false; // Extra safety
}

// Deprecated - keeping old listener removal for safety
document.getElementById('quickReminderForm')?.removeEventListener('submit', handleQuickReminderSubmit);

// Notification function (if not already defined)
function showToastNotification(message, type = 'info') {
    // Check if function already exists in app.js
    if (typeof window.showNotification === 'function') {
        window.showNotification(message, type);
        return;
    }
    
    // Fallback notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Hide "Kalenderen tar litt tid √• laste" message
setTimeout(function() {
    const loadingEl = document.getElementById('calendar-loading');
    if (loadingEl && loadingEl.style.display !== 'none') {
        loadingEl.style.display = 'none';
    }
}, 500);

// Enhanced push notification status check and mobile PWA features
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard PWA and notification features initializing...');
    
    // Check PWA installation status
    if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üì± Running in standalone mode (PWA installed)');
        // Hide install button since app is already installed
        const installBtn = document.getElementById('installBtn');
        if (installBtn) installBtn.style.display = 'none';
    } else {
        console.log('üåê Running in browser mode');
        // Show install button after a delay
        setTimeout(() => {
            const installBtn = document.getElementById('installBtn');
            if (installBtn && window.deferredPrompt) {
                installBtn.style.display = 'inline-block';
            }
        }, 3000);
    }
    
    // Enhanced push notification status check
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.ready.then(function(registration) {
            console.log('‚úÖ Service Worker ready, checking push subscription...');
            return registration.pushManager.getSubscription();
        }).then(function(subscription) {
            const enableBtn = document.getElementById('enablePushBtn');
            
            if (subscription) {
                console.log('‚úÖ Push subscription exists');
                if (enableBtn) {
                    enableBtn.style.display = 'none';
                    enableBtn.innerHTML = '<i class="fas fa-check"></i> Varsler aktive';
                }
            } else {
                console.log('‚ÑπÔ∏è No push subscription found');
                if (enableBtn && Notification.permission !== 'granted') {
                    enableBtn.style.display = 'inline-block';
                    enableBtn.innerHTML = '<i class="fas fa-bell"></i> Aktiver varsler';
                }
            }
        }).catch(function(error) {
            console.error('‚ùå Error checking push subscription:', error);
        });
    }
    
    // Mobile-specific optimizations
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        console.log('üì± Mobile device detected, applying mobile optimizations');
        
        // Add mobile-specific CSS
        const mobileStyles = document.createElement('style');
        mobileStyles.textContent = `
            .pwa-install-banner {
                position: fixed !important;
                bottom: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 9998 !important;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
                border-radius: 25px !important;
                animation: slideInUp 0.3s ease-out !important;
            }
            
            @keyframes slideInUp {
                from { transform: translateX(-50%) translateY(100px); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
            
            .mobile-notification-optimized {
                padding: 15px 25px !important;
                font-size: 18px !important;
                min-width: 280px !important;
                max-width: 90vw !important;
            }
        `;
        document.head.appendChild(mobileStyles);
        
        // Enhanced mobile notification handling
        if ('Notification' in window && Notification.permission === 'default') {
            setTimeout(() => {
                if (confirm('üîî Vil du motta varsler for p√•minnelser p√• denne enheten?')) {
                    requestPushPermission();
                }
            }, 8000);
        }
    }
});

// Enhanced push permission request function
function requestPushPermission() {
    console.log('üîî Requesting push notification permission');
    
    if (!('Notification' in window)) {
        showToastNotification('Varslinger st√∏ttes ikke p√• denne enheten', 'error');
        return;
    }
    
    if (Notification.permission === 'denied') {
        showToastNotification('Varslinger er blokkert. Aktiver dem i nettleserinnstillingene for √• motta p√•minnelser.', 'warning', 10000);
        return;
    }
    
    // Request permission
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            console.log('‚úÖ Notification permission granted');
            showToastNotification('Varslinger aktivert! üîî', 'success');
            
            // Hide the enable button
            const enableBtn = document.getElementById('enablePushBtn');
            if (enableBtn) {
                enableBtn.style.display = 'none';
            }
            
            // Initialize push notifications
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.pushManager.subscribe({
                        userVisibleOnly: true
                    });
                }).then(subscription => {
                    console.log('‚úÖ Push subscription successful');
                    // Send subscription to server
                    fetch('/api/push-subscription', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ subscription: subscription })
                    });
                }).catch(error => {
                    console.error('‚ùå Push subscription failed:', error);
                });
            }
        } else {
            console.log('‚ùå Notification permission denied');
            showToastNotification('Varslinger er n√∏dvendig for √• motta p√•minnelser', 'warning');
        }
    });
}

// Enhanced toast notification function
function showToastNotification(message, type = 'info', duration = 5000) {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());
    
    // Create toast
    const toast = document.createElement('div');
    toast.className = `toast-notification alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border-radius: 8px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }
    }, duration);
    
    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

// Add a function to preview sound selection
function previewSound(soundFile) {
    if (!soundFile) return;
    
    const audio = new Audio(`/static/sounds/${soundFile}`);
    audio.play().catch(error => {
        console.error('Could not play sound:', error);
        showToastNotification('Kunne ikke spille lyd: ' + error.message, 'error');
    });
}
</script>
{% endblock %}