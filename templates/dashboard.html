{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-bell fa-2x mb-2"></i>
                <h3 id="my-count" data-count="my">{{ stats.total }}</h3>
                <small>Mine p√•minnelser</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3 id="completed-count">{{ stats.completed }}</h3>
                <small>Fullf√∏rt</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-share fa-2x mb-2"></i>
                <h3 id="shared-count" data-count="shared">{{ stats.shared_count }}</h3>
                <small>Delt med meg</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-percent fa-2x mb-2"></i>
                <h3>{{ "%.0f"|format(stats.completion_rate) }}%</h3>
                <small>Fullf√∏ringsrate</small>
            </div>
        </div>
    </div>
</div>

<!-- New Reminder Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-plus"></i> Ny p√•minnelse</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('add_reminder') }}" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <div class="form-floating mb-3">
                        {{ form.title(class="form-control", placeholder="Tittel", required=true) }}
                        {{ form.title.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-6 col-md-12">
                    <div class="form-floating mb-3">
                        {{ form.category(class="form-select") }}
                        {{ form.category.label(class="form-label") }}
                    </div>
                </div>
            </div>

            <div class="form-floating mb-3">
                {{ form.description(class="form-control", placeholder="Beskrivelse", rows="3") }}
                {{ form.description.label(class="form-label") }}
            </div>

            <div class="row">
                <div class="col-lg-4 col-md-6 col-sm-12">
                    <div class="form-floating mb-3">
                        {{ form.date(class="form-control", required=true) }}
                        {{ form.date.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-12">
                    <div class="form-floating mb-3">
                        {{ form.time(class="form-control", required=true) }}
                        {{ form.time.label(class="form-label") }}
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 col-sm-12">
                    <div class="form-floating mb-3">
                        {{ form.priority(class="form-select") }}
                        {{ form.priority.label(class="form-label") }}
                    </div>
                </div>
            </div>

            {% if available_users %}
            <div class="mb-3">
                <label class="form-label">Del med:</label>
                <div class="row">
                    {% for user in available_users %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="share_with" value="{{ user }}" id="user_{{ loop.index }}">
                            <label class="form-check-label" for="user_{{ loop.index }}">
                                {{ user }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="d-grid">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>

<!-- My Reminders -->
<div class="row">
    <div class="col-lg-6 col-md-12 dashboard-col">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Mine p√•minnelser</h5>
                <span class="badge bg-primary">{{ my_reminders|length }}</span>
            </div>
            <div class="card-body">
                {% if my_reminders %}
                    {% for reminder in my_reminders %}
                    <div class="reminder-item card mb-3 priority-{{ reminder.priority.lower() }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">{{ reminder.title }}</h6>
                                    {% if reminder.description %}
                                    <p class="card-text text-muted small">{{ reminder.description }}</p>
                                    {% endif %}
                                    <div class="d-flex gap-2 flex-wrap">
                                        <span class="badge bg-primary">{{ reminder.datetime | format_datetime }}</span>
                                        <span class="badge category-badge bg-secondary">{{ reminder.category }}</span>
                                        <span class="badge bg-{{ 'danger' if reminder.priority == 'H√∏y' else 'warning' if reminder.priority == 'Medium' else 'success' }}">
                                            {{ reminder.priority }}
                                        </span>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('complete_reminder', reminder_id=reminder.id) }}">
                                            <i class="fas fa-check text-success"></i> Fullf√∏r
                                        </a></li>
                                        <li><button class="dropdown-item" onclick="shareReminder('{{ reminder.id }}', '{{ reminder.title }}')">
                                            <i class="fas fa-share text-info"></i> Del via e-post
                                        </button></li>
                                        <li><a class="dropdown-item" href="{{ url_for('delete_reminder', reminder_id=reminder.id) }}" 
                                               onclick="return confirm('Er du sikker p√• at du vil slette denne p√•minnelsen?')">
                                            <i class="fas fa-trash text-danger"></i> Slett
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bell-slash fa-3x mb-3"></i>
                        <p>Ingen p√•minnelser enn√•</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Shared Reminders -->
    <div class="col-lg-6 col-md-12 dashboard-col">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-share"></i> Delt med meg</h5>
                <span class="badge bg-info">{{ shared_reminders|length }}</span>
            </div>
            <div class="card-body">
                {% if shared_reminders %}
                    {% for reminder in shared_reminders %}
                    <div class="reminder-item card mb-3 priority-{{ reminder.priority.lower() }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        {{ reminder.title }}
                                        <small class="text-muted">av {{ reminder.shared_by }}</small>
                                    </h6>
                                    {% if reminder.description %}
                                    <p class="card-text text-muted small">{{ reminder.description }}</p>
                                    {% endif %}
                                    <div class="d-flex gap-2 flex-wrap">
                                        <span class="badge bg-primary">{{ reminder.datetime | format_datetime }}</span>
                                        <span class="badge category-badge bg-secondary">{{ reminder.category }}</span>
                                        <span class="badge bg-{{ 'danger' if reminder.priority == 'H√∏y' else 'warning' if reminder.priority == 'Medium' else 'success' }}">
                                            {{ reminder.priority }}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <a href="{{ url_for('complete_reminder', reminder_id=reminder.id) }}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-check"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-share-alt fa-3x mb-3"></i>
                        <p>Ingen delte p√•minnelser</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Kalendervisning</h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="calendarView" id="monthView" autocomplete="off" checked>
                    <label class="btn btn-outline-primary btn-sm" for="monthView">M√•ned</label>
                    
                    <input type="radio" class="btn-check" name="calendarView" id="weekView" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="weekView">Uke</label>
                    
                    <input type="radio" class="btn-check" name="calendarView" id="dayView" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="dayView">Dag</label>
                </div>
            </div>
            <div class="card-body p-1 p-md-3">
                <div id="calendar-loading" class="text-center p-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laster kalender...</span>
                    </div>
                    <p class="mt-2 text-muted">Laster kalender...</p>
                </div>
                
                <!-- Mobile calendar fallback -->
                <div id="calendar-fallback" class="text-center p-4" style="display: none; min-height: 400px; background: white; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                    <div class="mt-5">
                        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Kalender utilgjengelig</h5>
                        <p class="text-muted small">Kalenderen kunne ikke lastes. Pr√∏v √• oppdatere siden.</p>
                        <button onclick="location.reload()" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-refresh"></i> Oppdater side
                        </button>
                    </div>
                </div>
                
                <div id="calendar" style="min-height: 400px; background: white;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Share Reminder Modal -->
<div class="modal fade" id="shareReminderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-share"></i> Del p√•minnelse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('share_reminder') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="reminder_id" id="shareReminderIdInput">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">P√•minnelse:</label>
                        <p class="text-muted" id="shareReminderTitle"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailAddresses" class="form-label fw-bold">E-post adresser:</label>
                        <textarea class="form-control" name="email_addresses" id="emailAddresses" 
                                  rows="3" placeholder="Skriv inn e-post adresser separert med komma eller mellomrom"
                                  required></textarea>
                        <div class="form-text">Eksempel: person1@example.com, person2@example.com</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="personalMessage" class="form-label">Personlig melding (valgfritt):</label>
                        <textarea class="form-control" name="personal_message" id="personalMessage" 
                                  rows="3" placeholder="Legg til en personlig melding..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send p√•minnelse
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Reminder Modal -->
<div class="modal fade" id="quickReminderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö° Hurtig p√•minnelse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickReminderForm" action="/add_reminder" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="quickDate" name="date">
                    <input type="hidden" id="quickTime" name="time">
                    
                    <div class="mb-3">
                        <label for="quickTitle" class="form-label">Tittel</label>
                        <input type="text" class="form-control" id="quickTitle" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickDescription" class="form-label">Beskrivelse (valgfritt)</label>
                        <textarea class="form-control" id="quickDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="quickCategory" class="form-label">Kategori</label>
                            <select class="form-select" id="quickCategory" name="category">
                                <option value="Helse">‚öïÔ∏è Helse</option>
                                <option value="Familie">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie</option>
                                <option value="√òkonomi">üí∞ √òkonomi</option>
                                <option value="Utdanning">üìö Utdanning</option>
                                <option value="Annet" selected>üìé Annet</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quickPriority" class="form-label">Prioritet</label>
                            <select class="form-select" id="quickPriority" name="priority">
                                <option value="Lav">üü¢ Lav</option>
                                <option value="Medium" selected>üü° Medium</option>
                                <option value="H√∏y">üî¥ H√∏y</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            üìÖ <span id="selectedDateDisplay"></span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Opprett p√•minnelse
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsTitle">üìã P√•minnelse detaljer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetailsBody">
                <!-- Event details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
                <button type="button" class="btn btn-primary" id="shareEventBtn">
                    <i class="fas fa-share"></i> Del via e-post
                </button>
                <button type="button" class="btn btn-success" id="completeEventBtn">
                    <i class="fas fa-check"></i> Fullf√∏r
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="eventContextMenu" class="dropdown-menu" style="display: none; position: absolute; z-index: 1055;">
    <a class="dropdown-item" href="#" id="shareEventContext">
        <i class="fas fa-share"></i> Del via e-post
    </a>
    <a class="dropdown-item" href="#" id="editEventContext">
        <i class="fas fa-edit"></i> Rediger
    </a>
    <a class="dropdown-item" href="#" id="completeEventContext">
        <i class="fas fa-check"></i> Fullf√∏r
    </a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item text-danger" href="#" id="deleteEventContext">
        <i class="fas fa-trash"></i> Slett
    </a>
</div>

{% endblock %}

{% block scripts %}
<!-- FullCalendar CSS & JS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<script>
// Calendar initialization
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    if (!calendarEl) {
        console.error('Calendar element not found');
        return;
    }
    
    // Show loading indicator
    const loadingEl = document.getElementById('calendar-loading');
    if (loadingEl) {
        loadingEl.style.display = 'block';
    }
    
    // Prevent multiple calendar initialization
    if (window.calendar) {
        window.calendar.destroy();
    }
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: window.innerWidth < 768 ? 400 : 600,
        contentHeight: window.innerWidth < 768 ? 400 : 600,
        aspectRatio: window.innerWidth < 768 ? 1.2 : 1.35,
        events: {
            url: '/api/calendar-events',
            failure: function() {
                console.error('Failed to load calendar events');
                // Hide loading indicator
                const loadingEl = document.getElementById('calendar-loading');
                if (loadingEl) loadingEl.style.display = 'none';
                // Continue with empty calendar rather than white screen
                return [];
            }
        },
        loading: function(isLoading) {
            const loadingEl = document.getElementById('calendar-loading');
            const fallbackEl = document.getElementById('calendar-fallback');
            
            if (loadingEl) {
                loadingEl.style.display = isLoading ? 'block' : 'none';
            }
            
            console.log('Calendar loading:', isLoading);
            
            // Mobile-specific loading timeout check
            if (isLoading && window.innerWidth < 768) {
                setTimeout(() => {
                    if (loadingEl && loadingEl.style.display !== 'none') {
                        console.warn('Calendar taking too long to load on mobile, showing fallback');
                        loadingEl.style.display = 'none';
                        if (fallbackEl) fallbackEl.style.display = 'block';
                    }
                }, 10000); // 10 second timeout
            }
        },
        headerToolbar: {
            left: window.innerWidth < 768 ? 'prev,next' : 'prev,next today',
            center: 'title',
            right: window.innerWidth < 768 ? 'dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        selectable: true,
        editable: true,
        droppable: true,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        select: function(arg) {
            // Opprett ny p√•minnelse ved √• dra over flere dager/tid
            showQuickReminderModal(arg.start, arg.end, arg.allDay);
        },
        dateClick: function(info) {
            // Opprett ny p√•minnelse ved √• klikke p√• en dag
            showQuickReminderModal(info.date, null, info.allDay);
        },
        eventClick: function(info) {
            // Vis event detaljer med deling-mulighet
            showEventDetailsModal(info.event);
        },
        eventDrop: function(info) {
            // Oppdater p√•minnelse n√•r den flyttes
            updateReminderDateTime(info.event.id, info.event.start);
        },
        eventResize: function(info) {
            // Oppdater p√•minnelse n√•r varigheten endres
            updateReminderDateTime(info.event.id, info.event.start, info.event.end);
        },
        eventDidMount: function(info) {
            // Add tooltip and context menu
            info.el.setAttribute('title', info.event.extendedProps.description || '');
             
            // Legg til h√∏yreklikk for deling
            info.el.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showEventContextMenu(e, info.event);
            });
        }
    });
    
    calendar.render();
    window.calendar = calendar;
    
    // Enhanced mobile calendar debugging and fixes
    const isMobile = window.innerWidth < 768;
    console.log('Calendar initialized:', {
        width: window.innerWidth,
        height: window.innerHeight,
        isMobile: isMobile,
        calendarElement: calendarEl,
        calendarHeight: calendar.getOption('height'),
        calendarView: calendar.view.type
    });
    
    // Force calendar to be visible on mobile with multiple render attempts
    if (isMobile) {
        console.log('Applying mobile calendar fixes...');
        
        // Immediate fixes
        calendarEl.style.minHeight = '400px';
        calendarEl.style.background = 'white';
        calendarEl.style.display = 'block';
        calendarEl.style.visibility = 'visible';
        
        // Multiple render attempts for mobile
        setTimeout(() => {
            console.log('Mobile calendar render attempt 1');
            calendar.updateSize();
            calendar.render();
        }, 100);
        
        setTimeout(() => {
            console.log('Mobile calendar render attempt 2');
            calendar.updateSize();
            
            // Force show calendar if still not visible
            const fcView = calendarEl.querySelector('.fc-view-harness');
            if (fcView) {
                fcView.style.background = 'white';
                fcView.style.minHeight = '400px';
                fcView.style.display = 'block';
            }
        }, 500);
        
        setTimeout(() => {
            console.log('Mobile calendar render attempt 3');
            
            // Final check and force visibility
            const fcElements = calendarEl.querySelectorAll('.fc, .fc-view-harness, .fc-scrollgrid');
            fcElements.forEach(el => {
                el.style.background = 'white';
                el.style.display = 'block';
                el.style.visibility = 'visible';
            });
            
            calendar.updateSize();
            
            // Final visibility check - if calendar is still not properly visible, show fallback
            setTimeout(() => {
                const fcView = calendarEl.querySelector('.fc-view-harness');
                const fcScrollGrid = calendarEl.querySelector('.fc-scrollgrid');
                
                if (!fcView || !fcScrollGrid || fcView.offsetHeight < 50) {
                    console.warn('Calendar still not visible after all attempts, showing fallback');
                    const fallbackEl = document.getElementById('calendar-fallback');
                    if (fallbackEl) {
                        calendarEl.style.display = 'none';
                        fallbackEl.style.display = 'block';
                    }
                }
            }, 500);
        }, 1000);
    }
    
    // Handle window resize for mobile responsiveness
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (calendar) {
                // Update calendar options based on screen size
                const isMobile = window.innerWidth < 768;
                calendar.setOption('height', isMobile ? 400 : 600);
                calendar.setOption('contentHeight', isMobile ? 400 : 600);
                calendar.setOption('aspectRatio', isMobile ? 1.2 : 1.35);
                calendar.setOption('headerToolbar', {
                    left: isMobile ? 'prev,next' : 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
                });
                calendar.updateSize();
            }
        }, 250);
    });
    
    // Force calendar to render properly on mobile
    setTimeout(() => {
        if (calendar && window.innerWidth < 768) {
            calendar.updateSize();
        }
    }, 500);
    
    // Calendar view switcher
    document.querySelectorAll('input[name="calendarView"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.id === 'monthView') {
                calendar.changeView('dayGridMonth');
            } else if (this.id === 'weekView') {
                calendar.changeView('timeGridWeek');
            } else if (this.id === 'dayView') {
                calendar.changeView('timeGridDay');
            }
        });
    });
    
    // Quick reminder form event listener (only add once)
    const quickForm = document.getElementById('quickReminderForm');
    if (quickForm && !quickForm.hasAttribute('data-listener-added')) {
        quickForm.setAttribute('data-listener-added', 'true');
        quickForm.addEventListener('submit', handleQuickReminderSubmit);
    }
});

// Share reminder function
function shareReminder(reminderId, reminderTitle) {
    document.getElementById('shareReminderIdInput').value = reminderId;
    document.getElementById('shareReminderTitle').textContent = reminderTitle;
    
    var modal = new bootstrap.Modal(document.getElementById('shareReminderModal'));
    modal.show();
}

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Update reminder count
function updateReminderCount() {
    fetch('/api/reminder-count')
        .then(response => response.json())
        .then(data => {
            if (data.my_count !== undefined) {
                const myCountEl = document.querySelector('[data-count="my"]');
                if (myCountEl) myCountEl.textContent = data.my_count;
            }
            if (data.shared_count !== undefined) {
                const sharedCountEl = document.querySelector('[data-count="shared"]');
                if (sharedCountEl) sharedCountEl.textContent = data.shared_count;
            }
            if (data.total_count !== undefined) {
                const totalCountEl = document.querySelector('[data-count="total"]');
                if (totalCountEl) totalCountEl.textContent = data.total_count;
            }
        })
        .catch(error => console.log('Error updating reminder count:', error));
}

// Auto-refresh reminder count every 5 minutes
setInterval(updateReminderCount, 300000);

// Quick reminder modal functions
function showQuickReminderModal(startDate, endDate, allDay) {
    const modal = new bootstrap.Modal(document.getElementById('quickReminderModal'));
    
    // Ensure we have valid dates
    if (!startDate) {
        console.error('showQuickReminderModal called without startDate');
        return;
    }
    
    // Set date and time values
    const date = new Date(startDate);
    if (isNaN(date.getTime())) {
        console.error('Invalid date provided to showQuickReminderModal:', startDate);
        return;
    }
    
    const dateStr = date.toISOString().split('T')[0];
    const timeStr = allDay ? '09:00' : date.toTimeString().slice(0, 5);
    
    document.getElementById('quickDate').value = dateStr;
    document.getElementById('quickTime').value = timeStr;
    
    // Safe date formatting
    try {
        document.getElementById('selectedDateDisplay').textContent = 
            date.toLocaleDateString('nb-NO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) + (allDay ? '' : ` kl. ${timeStr}`);
    } catch (e) {
        console.error('Error formatting date:', e);
        document.getElementById('selectedDateDisplay').textContent = `${dateStr} ${timeStr}`;
    }
    
    // Clear form
    document.getElementById('quickTitle').value = '';
    document.getElementById('quickDescription').value = '';
    document.getElementById('quickCategory').value = 'Annet';
    document.getElementById('quickPriority').value = 'Medium';
    
    modal.show();
    
    // Focus on title field
    setTimeout(() => {
        document.getElementById('quickTitle').focus();
    }, 500);
}

// Event details modal
function showEventDetailsModal(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    const props = event.extendedProps;
    
    document.getElementById('eventDetailsTitle').textContent = event.title;
    
    let detailsHtml = `
        <div class="row">
            <div class="col-12 mb-3">
                <h6>${event.title}</h6>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>üìÖ Dato og tid:</strong><br>
                <span class="text-muted">${event.start.toLocaleString('nb-NO')}</span>
            </div>
            <div class="col-md-6">
                <strong>üè∑Ô∏è Kategori:</strong><br>
                <span class="badge bg-secondary">${props.category}</span>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>‚ö° Prioritet:</strong><br>
                <span class="badge bg-${props.priority === 'H√∏y' ? 'danger' : props.priority === 'Medium' ? 'warning' : 'success'}">${props.priority}</span>
            </div>
            ${props.sharedBy ? `<div class="col-md-6"><strong>üë§ Delt av:</strong><br><span class="text-muted">${props.sharedBy}</span></div>` : ''}
        </div>
    `;
    
    if (props.description) {
        detailsHtml += `
            <div class="mb-3">
                <strong>üìù Beskrivelse:</strong><br>
                <div class="text-muted">${props.description}</div>
            </div>
        `;
    }
    
    document.getElementById('eventDetailsBody').innerHTML = detailsHtml;
    
    // Set up action buttons
    const shareBtn = document.getElementById('shareEventBtn');
    const completeBtn = document.getElementById('completeEventBtn');
    
    shareBtn.onclick = () => {
        modal.hide();
        shareEventViaEmail(event);
    };
    
    if (props.type === 'my') {
        completeBtn.style.display = 'block';
        completeBtn.onclick = () => {
            completeReminder(event.id);
            modal.hide();
        };
    } else {
        completeBtn.style.display = 'none';
    }
    
    modal.show();
}

// Context menu
let currentContextEvent = null;

function showEventContextMenu(e, event) {
    const menu = document.getElementById('eventContextMenu');
    currentContextEvent = event;
    
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.style.display = 'block';
    
    // Hide on click outside
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu, { once: true });
    }, 100);
}

function hideContextMenu() {
    document.getElementById('eventContextMenu').style.display = 'none';
    currentContextEvent = null;
}

// Context menu actions
document.getElementById('shareEventContext').addEventListener('click', function(e) {
    e.preventDefault();
    if (currentContextEvent) {
        shareEventViaEmail(currentContextEvent);
        hideContextMenu();
    }
});

document.getElementById('completeEventContext').addEventListener('click', function(e) {
    e.preventDefault();
    if (currentContextEvent && currentContextEvent.extendedProps.type === 'my') {
        completeReminder(currentContextEvent.id);
        hideContextMenu();
    }
});

// Share event via email
function shareEventViaEmail(event) {
    document.getElementById('shareReminderIdInput').value = event.id.replace('shared_', '');
    document.getElementById('shareReminderTitle').textContent = event.title;
    document.getElementById('emailAddresses').value = '';
    document.getElementById('personalMessage').value = '';
    
    const shareModal = new bootstrap.Modal(document.getElementById('shareReminderModal'));
    shareModal.show();
}

// Override the share form submission to use calendar API
document.getElementById('shareReminderModal').querySelector('form').addEventListener('submit', function(e) {
    if (currentContextEvent) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            reminder_id: formData.get('reminder_id'),
            email_addresses: formData.get('email_addresses'),
            personal_message: formData.get('personal_message')
        };
        
        fetch('/api/share-calendar-event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrf_token')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToastNotification('üìß ' + (data.message || 'Kalenderinvitasjon sendt!'), 'success');
                bootstrap.Modal.getInstance(document.getElementById('shareReminderModal')).hide();
            } else {
                showToastNotification('‚ùå ' + (data.error || 'Kunne ikke sende invitasjon'), 'error');
            }
        })
        .catch(error => {
            console.error('Error sharing calendar event:', error);
            showToastNotification('‚ùå Feil ved sending av invitasjon', 'error');
        });
    }
});

// Update reminder date/time via drag & drop
function updateReminderDateTime(eventId, newStart, newEnd) {
    const cleanId = eventId.replace('shared_', '');
    const newDate = newStart.toISOString().split('T')[0];
    const newTime = newStart.toTimeString().slice(0, 5);
    
    // Get CSRF token from any form on the page
    const csrfToken = document.querySelector('input[name=csrf_token]').value;
    
    fetch('/api/update-reminder-datetime', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            reminder_id: cleanId,
            date: newDate,
            time: newTime
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToastNotification('üìÖ P√•minnelse oppdatert!', 'success');
        } else {
            showToastNotification('‚ùå Kunne ikke oppdatere p√•minnelse: ' + (data.error || 'Ukjent feil'), 'error');
            // Revert calendar if needed
            if (window.calendar) {
                window.calendar.refetchEvents();
            }
        }
    })
    .catch(error => {
        console.error('Error updating reminder:', error);
        showToastNotification('‚ùå Feil ved oppdatering: ' + error.message, 'error');
        if (window.calendar) {
            window.calendar.refetchEvents();
        }
    });
}

// Complete reminder function
function completeReminder(reminderId) {
    const cleanId = reminderId.replace('shared_', '');
    
    fetch(`/complete_reminder/${cleanId}`, {
        method: 'GET'
    })
    .then(response => {
        if (response.ok) {
            showToastNotification('‚úÖ P√•minnelse fullf√∏rt!', 'success');
            if (window.calendar) {
                window.calendar.refetchEvents();
            }
            // Update reminder count instead of reloading
            updateReminderCount();
        } else {
            showToastNotification('‚ùå Kunne ikke fullf√∏re p√•minnelse', 'error');
        }
    })
    .catch(error => {
        console.error('Error completing reminder:', error);
        showToastNotification('‚ùå Feil ved fullf√∏ring', 'error');
    });
}

// Quick reminder form submission handler
function handleQuickReminderSubmit(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Validate required fields
    if (!data.title || !data.date || !data.time) {
        showToastNotification('‚ùå Tittel, dato og tid er p√•krevd', 'error');
        return false;
    }
    
    // Extra validation for data integrity
    if (data.title.length > 200) {
        showToastNotification('‚ùå Tittel er for lang (maks 200 tegn)', 'error');
        return false;
    }
    
    // Get CSRF token specifically from this form
    const csrfToken = form.querySelector('[name=csrf_token]').value;
    if (!csrfToken) {
        showToastNotification('‚ùå Sikkerhetsfeil - pr√∏v √• last siden p√• nytt', 'error');
        return false;
    }
    
    // Disable submit button to prevent double submission
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Oppretter...';
    }
    
    fetch('/add_reminder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToastNotification('‚úÖ P√•minnelse opprettet!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('quickReminderModal')).hide();
            
            // Properly refresh calendar events
            if (window.calendar) {
                window.calendar.refetchEvents();
            }
            // Update reminder count
            updateReminderCount();
        } else {
            showToastNotification('‚ùå Kunne ikke opprette p√•minnelse: ' + (data.error || 'Ukjent feil'), 'error');
        }
    })
    .catch(error => {
        console.error('Error creating reminder:', error);
        showToastNotification('‚ùå Feil ved opprettelse: ' + error.message, 'error');
    })
    .finally(() => {
        // Re-enable submit button
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Opprett p√•minnelse';
        }
    });
    
    return false; // Extra safety
}

// Deprecated - keeping old listener removal for safety
document.getElementById('quickReminderForm')?.removeEventListener('submit', handleQuickReminderSubmit);

// Notification function (if not already defined)
function showToastNotification(message, type = 'info') {
    // Check if function already exists in app.js
    if (typeof window.showNotification === 'function') {
        window.showNotification(message, type);
        return;
    }
    
    // Fallback notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}